<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../vaadin-date-picker/vaadin-date-picker-light.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../d2l-time-picker/d2l-time-picker.html">
<link rel="import" href="../d2l-intl/d2l-intl.html">

<!--
`d2l-date-picker`
A Date Picker for D2L Brightspace

@demo demo/index.html
-->

<dom-module id="d2l-date-picker">
	<template>
		<custom-style>
			<style is="custom-style" include="d2l-input-styles">
				:host {
					display: block;
				}
				:host([hide-label]) > label,
				.d2l-date-picker-description {
					left: -10000px;
					position: absolute;
				}

				vaadin-date-picker-light {
					--primary-color: var(--d2l-color-celestine);
					--light-primary-color: var(--d2l-color-celestine-plus-1);
					--dark-theme-background-color: var(--d2l-color-ferrite);
					--dark-theme-secondary-color: #ffffff;
					--primary-text-color: var(--d2l-color-ferrite);
					--secondary-text-color: var(--d2l-color-tungsten);

					--vaadin-date-picker-overlay: {
						font-family: inherit;
						max-height: 355px;
					};
					--vaadin-date-picker-yearscroller: {
						font-family: inherit;
					};
					--vaadin-date-picker-header: {
						font-family: inherit;
					};
					--vaadin-date-picker-calendar-title: {
						font-family: inherit;
					};
					--vaadin-date-picker-calendar-cell: {
						font-family: inherit;
					};
					--vaadin-date-picker-footer: {
						font-family: inherit;
					};
					--vaadin-date-picker-calendar: {
						font-family: inherit;
					};
				};
			</style>
		</custom-style>

		<label for="input">{{label}}</label>
		<vaadin-date-picker-light min="[[min]]" max="[[max]]" value="{{value}}" on-value-changed="handleValueChanged">
			<iron-a11y-keys target="[[target]]" keys="enter" on-keys-pressed="_onEnter"></iron-a11y-keys>
			<iron-a11y-keys target="[[target]]" keys="up down" on-keys-pressed="_onUpDown"></iron-a11y-keys>
			<iron-input>
				<input id="input" on-tap="_handleTap" placeholder="{{placeholder}}" class="d2l-input" is="iron-input" type="text" on-focus="_handleFocus" aria-describedby="description"/>
				<div id="description" class="d2l-date-picker-description" >{{ariaDescription}}</div>
			</iron-input>
		</vaadin-date-picker-light>
	</template>

	<script>
		Polymer({

			is: 'd2l-date-picker',

			target: {
				type: Object
			},

			properties: {
				placeholder: {
					type: String
				},
				min: {
					type: String
				},
				max: {
					type: String
				},
				value: {
					type: String,
					reflectToAttribute: true,
					notify: true
				},
				label: {
					type: String
				},
				hideLabel: {
					type: Boolean,
					value: false,
					reflectToAttribute: true
				},
				ariaDescription:{
					type: String
				},
				locale: {
					type: String,
					default: 'en',
					observer: '_updateDatePickeri18n'
				}
			},

			_conditionalClass: function(hideLabel) {
				return hideLabel ? 'offscreen' : '';
			},

			observers: [
				'_updateDatePickeri18n()'
			],

			ready: function() {
				this.target = this.$.input;
				this._updateDatePickeri18n();
			},

			attached: function() {
				var buttons = document.getElementsByClassName('vaadin-date-picker-overlay paper-button-0');
				for (var i = 0; i < buttons.length; i++) {
					buttons[i].style.fontFamily = 'inherit';
				}
			},

			handleValueChanged: function(e, detail) {
				this.fire('d2l-date-picker-value-changed', e, detail);
			},

			_handleTap: function() {
				var datepicker = this.$$('vaadin-date-picker-light');
				if ( !datepicker.opened ) {
					datepicker._focusOverlayOnOpen = true;
				}
			},

			_onEnter: function(e) {
				var datepicker = this.$$('vaadin-date-picker-light');
				if ( !datepicker.opened ) {
					// A better solution is to add a boolean to the 3rd party open function
					datepicker._focusOverlayOnOpen = true;
					datepicker.open();
					e.detail.keyboardEvent.preventDefault();
					e.detail.keyboardEvent.stopPropagation();
				}

			},

			_onUpDown: function(e) {
				var datepicker = this.$$('vaadin-date-picker-light');
				if ( !datepicker.opened ) {
					e.detail.keyboardEvent.preventDefault();
					e.detail.keyboardEvent.stopPropagation();
				}
			},

			focus: function() {
				this.$$('input').focus();
			},

			_handleFocus: function() {
				// in shady DOM the input's "focus" event does not bubble,
				// so no need to fire it
				if (!Polymer.Settings.useShadow) {
					this.dispatchEvent( new CustomEvent(
							'focus',
							{bubbles: true, composed: false}
						) );
				}
			},

			_updateDatePickeri18n: function() {
				var locale = d2lIntl.LocaleProvider(this.locale);

				var datePicker = this.$$('vaadin-date-picker-light');
				var localeOverrides = {
					monthNames: locale.date.calendar.months.long,
					weekdays: locale.date.calendar.days.long,
					weekdaysShort: locale.date.calendar.days.short,
					firstDayOfWeek: locale.date.calendar.firstDayOfWeek
				};
				var datePickerLocale = this._merge(datePicker.i18n, localeOverrides);
				datePicker.i18n = {}; // reassign to have Polymer refresh
				datePicker.i18n = datePickerLocale;
			},

			_merge: function(obj1, obj2) {
				if (obj2 === undefined || obj2 === null || typeof(obj2) !== 'object') {
					return obj1;
				}
				Object.keys(obj2).forEach( function(i) {
					if (obj1.hasOwnProperty(i)) {
						if (typeof(obj2[i]) === 'object' && typeof(obj1[i]) === 'object' ) {
							this._merge(obj1[i], obj2[i]);
						} else {
							obj1[i] = obj2[i];
						}
					}
				}.bind(this));
				return obj1;
			}
		});
	</script>
</dom-module>
